
install.packages("shiny")
install.packages("readr")
install.packages("shinythemes")
library(shiny)
library(readr)
library(shinythemes)

# --- CHARGEMENT DES DONNÃ‰ES ---
# Assurez-vous que le fichier est dans le mÃªme dossier que ce script
donnees <- read.csv("~/Library/CloudStorage/OneDrive-etu.unistra.fr/travel_recommendations.csv", stringsAsFactors = FALSE)

# --- DICTIONNAIRES ---
trad_cat <- c("Aventure" = "adventure", "Plages" = "beaches", "Culture" = "culture", 
              "DÃ©sert" = "desert", "ForÃªt" = "forest", "ÃŽles" = "islands", "Montagnes" = "mountains")
trad_comp <- c("En couple" = "couple", "En famille" = "family", "Entre amis" = "friends", "Seul(e)" = "solo")
trad_clim <- c("Froid/Doux" = "cold/mild", "Chaud/Sec" = "hot/dry", "Humide" = "humid", 
               "Doux" = "mild", "Tropical" = "tropical", "Tropical/Chaud" = "tropical/warm", "Variable" = "variable")
trad_frequent <- c("AnimÃ©" = "lively", "ModÃ©rÃ©" = "Moderate", "Calme" = "quiet")
trad_mois <- c("Janvier" = "January", "FÃ©vrier" = "February", "Mars" = "March", "Avril" = "April", 
               "Mai" = "May", "Juin" = "June", "Juillet" = "July", "AoÃ»t" = "August", 
               "Septembre" = "September", "Octobre" = "October", "Novembre" = "November", "DÃ©cembre" = "December")
trad_act <- c("Balades en bateau" = "boat rides", "Promenades Ã  chameau" = "camel rides", 
              "Parcours historiques" = "heritage walks", "RandonnÃ©e" = "hiking", 
              "Visites de musÃ©es" = "museum tours", "Marches en pleine nature" = "nature walks", 
              "Parapente" = "paragliding", "Rafting" = "rafting", "Sandboarding" = "sandboarding", 
              "Snorkeling" = "snorkeling", "Baignade" = "swimming", "Trekking" = "trekking", 
              "Safari photo" = "wildlife safari")

# --- INTERFACE UTILISATEUR ---
ui <- fluidPage(
  theme = shinytheme("flatly"),
  
  # Confettis Ã  l'ouverture (comme dans votre exemple)
  tags$head(
    tags$script(src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"),
    tags$script(HTML("window.onload = function() { confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }}); };"))
  ),

  titlePanel("ðŸŒ Assistant Voyage Personnel"),
  
  sidebarLayout(
    sidebarPanel(
      h4("âœˆï¸ Vos prÃ©fÃ©rences"),
      selectInput("cat", "Type de voyage :", choices = names(trad_cat)),
      selectInput("comp", "Accompagnants :", choices = names(trad_comp)),
      selectInput("mois", "Mois de dÃ©part :", choices = names(trad_mois)),
      selectInput("clim", "Climat prÃ©fÃ©rÃ© :", choices = names(trad_clim)),
      selectInput("freq", "FrÃ©quentation :", choices = names(trad_frequent)),
      selectInput("act", "ActivitÃ© favorite :", choices = names(trad_act)),
      hr(),
      actionButton("go", "Trouver ma destination âœˆï¸", class = "btn-success", width = "100%")
    ),
    
    mainPanel(
      h3("ðŸï¸ Nos suggestions pour vous :"),
      tableOutput("resultats"),
      
      # Zone pour le filtre strict (apparaÃ®t aprÃ¨s le premier calcul)
      uiOutput("prio_ui")
    )
  )
)

# --- LOGIQUE SERVEUR ---
server <- function(input, output, session) {
  
  # Stockage des rÃ©sultats pour pouvoir les filtrer aprÃ¨s
  valeurs <- reactiveValues(top_voyages = NULL, scores = NULL)

  observeEvent(input$go, {
    # 1. RÃ©cupÃ©ration et traduction des choix
    req_cat <- trad_cat[input$cat]
    req_comp <- trad_comp[input$comp]
    req_mois <- trad_mois[input$mois]
    req_clim <- trad_clim[input$clim]
    req_freq <- trad_frequent[input$freq]
    req_act <- trad_act[input$act]

    # 2. Calcul du Score (MÃªme logique que votre script original)
    scores <- rep(0, nrow(donnees))
    scores <- scores + (donnees$category == req_cat)
    scores <- scores + (donnees$companions == req_comp)
    scores <- scores + (donnees$climate == req_clim)
    scores <- scores + (donnees$crowd_level == req_freq)
    scores <- scores + grepl(req_mois, donnees$best_months)
    scores <- scores + grepl(req_act, donnees$activities)
    
    # 3. PrÃ©paration du Top 3
    top_indices <- order(scores, decreasing = TRUE)[1:3]
    res <- donnees[top_indices, ]
    res$Adequation <- paste0(round((scores[top_indices] / 6) * 100), "%")
    
    valeurs$top_voyages <- res
    valeurs$scores <- scores
  })

  # Affichage du tableau
  output$resultats <- renderTable({
    req(valeurs$top_voyages)
    valeurs$top_voyages[, c("destination", "country", "category", "Adequation")]
  }, striped = TRUE, hover = TRUE, bordered = TRUE)

  # UI pour les critÃ¨res prioritaires (s'affiche seulement si on a dÃ©jÃ  des rÃ©sultats)
  output$prio_ui <- renderUI({
    req(valeurs$top_voyages)
    tagList(
      hr(),
      h4("âš™ï¸ Pas satisfait ? Imposez 2 critÃ¨res prioritaires"),
      fluidRow(
        column(6, selectInput("crit1", "PrioritÃ© 1", choices = c("CatÃ©gorie"=1, "Compagnons"=2, "Mois"=3, "Climat"=4, "FrÃ©quentation"=5, "ActivitÃ©"=6))),
        column(6, selectInput("crit2", "PrioritÃ© 2", choices = c("CatÃ©gorie"=1, "Compagnons"=2, "Mois"=3, "Climat"=4, "FrÃ©quentation"=5, "ActivitÃ©"=6)))
      ),
      actionButton("prio_btn", "Appliquer le filtre strict", class = "btn-warning"),
      textOutput("prio_res")
    )
  })

  # Logique du filtre strict
  observeEvent(input$prio_btn, {
    req(valeurs$scores)
    
    # Fonction de vÃ©rification (adaptÃ©e de votre script)
    verifier <- function(idx, num) {
      if (num == 1) return(donnees$category[idx] == trad_cat[input$cat])
      if (num == 2) return(donnees$companions[idx] == trad_comp[input$comp])
      if (num == 3) return(grepl(trad_mois[input$mois], donnees$best_months[idx]))
      if (num == 4) return(donnees$climate[idx] == trad_clim[input$clim])
      if (num == 5) return(donnees$crowd_level[idx] == trad_frequent[input$freq])
      if (num == 6) return(grepl(trad_act[input$act], donnees$activities[idx]))
      return(TRUE)
    }

    strict <- sapply(1:nrow(donnees), function(i) verifier(i, as.numeric(input$crit1)) && verifier(i, as.numeric(input$crit2)))

    output$prio_res <- renderText({
      if (any(strict)) {
        possibilites <- donnees[strict, ]
        best <- possibilites$destination[order(valeurs$scores[strict], decreasing = TRUE)[1]]
        paste("La meilleure destination respectant strictement vos prioritÃ©s est :", best)
      } else {
        "DÃ©solÃ©, aucune destination ne correspond Ã  ces critÃ¨res combinÃ©s."
      }
    })
  })
}

shinyApp(ui, server)

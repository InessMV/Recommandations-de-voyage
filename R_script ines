---
title: "Untitled"
author: "..."
date: "2026-01-07"
output: html_document
---

```{r}
#install.packages("shiny")
#install.packages("readr")
#install.packages("shinythemes")
library(shiny)
library(shinythemes)

# --- 1. CHARGEMENT DES DONNÃ‰ES ---
# Note : VÃ©rifiez que le fichier est bien dans le mÃªme dossier que ce script
donnees <- read.csv("~/Library/CloudStorage/OneDrive-etu.unistra.fr/travel_recommendations.csv", stringsAsFactors = FALSE)

# --- 2. DICTIONNAIRES DE TRADUCTION ---
trad_cat <- c("Aventure" = "adventure", "Plages" = "beaches", "Culture" = "culture", 
              "DÃ©sert" = "desert", "ForÃªt" = "forest", "ÃŽles" = "islands", "Montagnes" = "mountains")
trad_comp <- c("En couple" = "couple", "En famille" = "family", "Entre amis" = "friends", "Seul(e)" = "solo")
trad_clim <- c("Froid/Doux" = "cold/mild", "Chaud/Sec" = "hot/dry", "Humide" = "humid", 
               "Doux" = "mild", "Tropical" = "tropical", "Tropical/Chaud" = "tropical/warm", "Variable" = "variable")
trad_frequent <- c("AnimÃ©" = "lively", "ModÃ©rÃ©" = "Moderate", "Calme" = "quiet")
trad_mois <- c("Janvier" = "January", "FÃ©vrier" = "February", "Mars" = "March", "Avril" = "April", 
               "Mai" = "May", "Juin" = "June", "Juillet" = "July", "AoÃ»t" = "August", 
               "Septembre" = "September", "Octobre" = "October", "Novembre" = "November", "DÃ©cembre" = "December")
trad_act <- c("Balades en bateau" = "boat rides", "Promenades Ã  chameau" = "camel rides", 
              "Parcours historiques" = "heritage walks", "RandonnÃ©e" = "hiking", 
              "Visites de musÃ©es" = "museum tours", "Marches en pleine nature" = "nature walks", 
              "Parapente" = "paragliding", "Rafting" = "rafting", "Sandboarding" = "sandboarding", 
              "Snorkeling" = "snorkeling", "Baignade" = "swimming", "Trekking" = "trekking", 
              "Safari photo" = "wildlife safari")

# --- 3. INTERFACE UTILISATEUR (UI) ---
ui <- fluidPage(
  theme = shinytheme("flatly"),
  
  # Effet Confettis (comme dans votre exemple de films)
  tags$head(
    tags$script(src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"),
    tags$script(HTML("window.onload = function() { confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }}); };"))
  ),

  titlePanel("ðŸŒ Assistant Voyage Personnel"),
  
  sidebarLayout(
    sidebarPanel(
      h4("âœˆï¸ Vos prÃ©fÃ©rences"),
      selectInput("cat", "Type de voyage :", choices = names(trad_cat)),
      selectInput("comp", "Accompagnants :", choices = names(trad_comp)),
      selectInput("mois", "Mois de dÃ©part :", choices = names(trad_mois)),
      selectInput("clim", "Climat prÃ©fÃ©rÃ© :", choices = names(trad_clim)),
      selectInput("freq", "FrÃ©quentation :", choices = names(trad_frequent)),
      selectInput("act", "ActivitÃ© favorite :", choices = names(trad_act)),
      hr(),
      actionButton("go", "Trouver ma destination âœˆï¸", class = "btn-success", width = "100%")
    ),
    
    mainPanel(
      h3("ðŸï¸ Nos suggestions pour vous :"),
      # Zone de message d'erreur personnalisÃ©e si rien n'est trouvÃ©
      uiOutput("message_vide"),
      tableOutput("resultats"),
      
      # Filtres prioritaires
      uiOutput("prio_ui")
    )
  )
)

# --- 4. LOGIQUE SERVEUR (SERVER) ---
server <- function(input, output, session) {
  
  valeurs <- reactiveValues(top_voyages = NULL, scores = NULL)

  observeEvent(input$go, {
    # Traductions
    req_cat  <- trad_cat[input$cat]
    req_comp <- trad_comp[input$comp]
    req_mois <- trad_mois[input$mois]
    req_clim <- trad_clim[input$clim]
    req_freq <- trad_frequent[input$freq]
    req_act  <- trad_act[input$act]

    # Calcul du Score
    scores <- rep(0, nrow(donnees))
    scores <- scores + (tolower(donnees$category) == req_cat)
    scores <- scores + (tolower(donnees$companions) == req_comp)
    scores <- scores + (tolower(donnees$climate) == req_clim)
    scores <- scores + (tolower(donnees$crowd_level) == req_freq)
    scores <- scores + grepl(req_mois, donnees$best_months, ignore.case = TRUE)
    scores <- scores + grepl(req_act, donnees$activities, ignore.case = TRUE)
    
    # SÃ©lection du Top 3
    top_indices <- order(scores, decreasing = TRUE)[1:3]
    res <- donnees[top_indices, ]
    
    # Ajout de la colonne adÃ©quation proprement
    res$Adequation <- paste0(round((scores[top_indices] / 6) * 100), "%")
    
    valeurs$top_voyages <- res
    valeurs$scores <- scores
    
    # Petit effet de succÃ¨s
    showNotification("Destinations trouvÃ©es !", type = "message")
  })

  # AFFICHAGE DU TABLEAU CORRIGÃ‰ (Sans colonnes forcÃ©es)
  output$resultats <- renderTable({
    req(valeurs$top_voyages)
    # On affiche tout le tableau sÃ©lectionnÃ© sans nommer les colonnes Ã  la main
    # Cela Ã©vite l'erreur "undefined columns"
    valeurs$top_voyages
  }, striped = TRUE, hover = TRUE, bordered = TRUE)

  # UI des Filtres
  output$prio_ui <- renderUI({
    req(valeurs$top_voyages)
    tagList(
      hr(),
      h4("âš™ï¸ Pas satisfait ? Imposez 2 critÃ¨res prioritaires"),
      fluidRow(
        column(6, selectInput("crit1", "PrioritÃ© 1", choices = list("Type de voyage"=1, "accompagnant"=2, "Mois"=3, "Climat"=4, "FrÃ©quentation"=5, "ActivitÃ©"=6))),
        column(6, selectInput("crit2", "PrioritÃ© 2", choices = list("Type de voyage"=1, "accompagnant"=2, "Mois"=3, "Climat"=4, "FrÃ©quentation"=5, "ActivitÃ©"=6)))
      ),
      actionButton("prio_btn", "Appliquer le filtre strict", class = "btn-warning"),
      br(), br(),
      span(textOutput("prio_res"), style="font-weight:bold; font-size: 1.2em; color: #2c3e50;")
    )
  })

  observeEvent(input$prio_btn, {
    req(valeurs$scores)
    
    verifier <- function(idx, num) {
      if (num == 1) return(tolower(donnees$category[idx]) == trad_cat[input$cat])
      if (num == 2) return(tolower(donnees$companions[idx]) == trad_comp[input$comp])
      if (num == 3) return(grepl(trad_mois[input$mois], donnees$best_months[idx], ignore.case = TRUE))
      if (num == 4) return(tolower(donnees$climate[idx]) == trad_clim[input$clim])
      if (num == 5) return(tolower(donnees$crowd_level[idx]) == trad_frequent[input$freq])
      if (num == 6) return(grepl(trad_act[input$act], donnees$activities[idx], ignore.case = TRUE))
      return(TRUE)
    }

    strict <- sapply(1:nrow(donnees), function(i) verifier(i, as.numeric(input$crit1)) && verifier(i, as.numeric(input$crit2)))

    output$prio_res <- renderText({
      if (any(strict)) {
        possibilites <- donnees[strict, ]
        best <- possibilites$destination[order(valeurs$scores[strict], decreasing = TRUE)[1]]
        paste("ðŸŒŸ La meilleure destination respectant strictement vos prioritÃ©s est :", best)
      } else {
        "âŒ DÃ©solÃ©, aucune destination ne correspond Ã  ce mÃ©lange de critÃ¨res."
      }
    })
  })
}

shinyApp(ui, server)
```

